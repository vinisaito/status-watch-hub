import boto3
import json
import logging

s3 = boto3.client("s3")
logger = logging.getLogger()
logger.setLevel(logging.INFO)

CACHE_BUCKET = "painel-monitoracao-administrativo-dados"
INDEX_KEY = "api_cache/index.json"

def lambda_handler(event, context):
    try:
        # Recebe parâmetro do front-end: part (opcional)
        part = int(event.get("queryStringParameters", {}).get("part", 1))
        logger.info(f"Solicitada a parte {part}")

        # Lê índice
        index_obj = s3.get_object(Bucket=CACHE_BUCKET, Key=INDEX_KEY)
        index_data = json.loads(index_obj["Body"].read().decode("utf-8"))

        total_parts = index_data["parts"]
        files = index_data["files"]

        if part < 1 or part > total_parts:
            return {
                "statusCode": 400,
                "body": json.dumps({"error": f"Part inválida. Deve ser entre 1 e {total_parts}"})
            }

        # Lê arquivo solicitado
        key = files[part - 1]
        logger.info(f"Lendo arquivo {key}")
        obj = s3.get_object(Bucket=CACHE_BUCKET, Key=key)
        data = json.loads(obj["Body"].read().decode("utf-8"))

        logger.info(f"Registros retornados: {len(data)}")

        return {
            "statusCode": 200,
            "headers": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET,OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
                "Content-Type": "application/json",
            },
            "body": json.dumps(data, ensure_ascii=False)
        }

    except Exception as e:
        logger.error(f"Erro: {str(e)}")
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
