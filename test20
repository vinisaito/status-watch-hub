import boto3
import json
import logging
from datetime import datetime, timedelta

# --- Configurações ---
s3 = boto3.client("s3")
logger = logging.getLogger()
logger.setLevel(logging.INFO)

CACHE_BUCKET = "painel-monitoracao-administrativo-dados"
CACHE_PREFIX = "api_cache/dados_part_"
SIGNED_URL_EXPIRATION = 3600  # segundos que o link ficará válido (1h por padrão)

def lambda_handler(event, context):
    try:
        logger.info("Iniciando geração de URLs pré-assinadas...")

        # Lista todos os arquivos de cache
        response = s3.list_objects_v2(Bucket=CACHE_BUCKET, Prefix=CACHE_PREFIX)
        if "Contents" not in response:
            return {
                "statusCode": 404,
                "body": json.dumps({"error": "Nenhum arquivo encontrado"})
            }

        # Ordena os arquivos por parte
        files = sorted([obj["Key"] for obj in response["Contents"]])

        # Gera URLs pré-assinadas
        presigned_urls = []
        for key in files:
            url = s3.generate_presigned_url(
                ClientMethod="get_object",
                Params={"Bucket": CACHE_BUCKET, "Key": key},
                ExpiresIn=SIGNED_URL_EXPIRATION
            )
            presigned_urls.append({
                "part": key.split("_")[-1].replace(".json", ""),
                "url": url
            })

        logger.info(f"Geradas {len(presigned_urls)} URLs.")

        # Retorna apenas as URLs
        return {
            "statusCode": 200,
            "headers": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET,OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
                "Content-Type": "application/json",
            },
            "body": json.dumps({
                "status": "ok",
                "total_parts": len(presigned_urls),
                "signed_urls": presigned_urls
            }, ensure_ascii=False),
        }

    except Exception as e:
        logger.error(f"Erro: {str(e)}")
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)}),
        }
