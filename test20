import boto3
import json
import os
import logging

s3 = boto3.client("s3")
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Configurações
CACHE_BUCKET = "painel-monitoracao-administrativo-dados"
CACHE_PREFIX = "api_cache/dados_part_"
MAX_PARTS = 10  # limite opcional para não retornar tudo de uma vez (ajuste se quiser)

def lambda_handler(event, context):
    try:
        logger.info("Iniciando leitura dos arquivos de cache...")

        # Lista todos os arquivos gerados pela Lambda 1
        response = s3.list_objects_v2(Bucket=CACHE_BUCKET, Prefix=CACHE_PREFIX)
        if "Contents" not in response:
            return {"statusCode": 404, "body": json.dumps({"error": "Nenhum arquivo encontrado"})}

        # Ordena as partes para garantir a sequência correta
        files = sorted([obj["Key"] for obj in response["Contents"]])

        # (Opcional) lê apenas uma parte ou até o máximo configurado
        files = files[:MAX_PARTS]

        all_data = []

        for key in files:
            logger.info(f"Lendo {key}")
            obj = s3.get_object(Bucket=CACHE_BUCKET, Key=key)
            data = json.loads(obj["Body"].read().decode("utf-8"))
            all_data.extend(data)

        logger.info(f"Total de registros retornados: {len(all_data)}")

        # Retorna como API REST (para API Gateway)
        return {
            "statusCode": 200,
            "headers": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET,OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
                "Content-Type": "application/json",
            },
            "body": json.dumps(all_data, ensure_ascii=False),
        }

    except Exception as e:
        logger.error(f"Erro: {str(e)}")
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)}),
        }
