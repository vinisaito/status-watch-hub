import { useState } from 'react';
import { AlertTriangle, AlertCircle, Clock, Timer, UserCheck, BarChart3, MessageCircle, CheckCircle2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AlertData {
  id: string;
  chamado: string;
  tipo_chamado: string;
  grupo_chamado: string;
  status_chamado: string;
  abertura_chamado: string;
  resumo_chamado: string;
  severidade_chamado: string;
  acionado: string;
  chat: boolean;
  sending_chat?: boolean;
}

interface MonitoringCardsProps {
  alertData: AlertData[];
  onFilterSelect: (filter: string | null) => void;
}

export const MonitoringCards = ({ alertData, onFilterSelect }: MonitoringCardsProps) => {
  const [activeFilter, setActiveFilter] = useState<string | null>(null);

  const handleCardClick = (filterKey: string) => {
    if (activeFilter === filterKey) {
      setActiveFilter(null);
      onFilterSelect(null);
    } else {
      setActiveFilter(filterKey);
      onFilterSelect(filterKey);
    }
  };

  const getTimeRemaining = (openingTime: string) => {
    const now = new Date();
    const opening = new Date(openingTime);
    const diffMs = now.getTime() - opening.getTime();
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const slaMinutes = 60;
    return slaMinutes - diffMinutes;
  };

  const total = alertData.length;
  const pendenteEnvioChat = alertData.filter(a => a.sending_chat === false || a.sending_chat === undefined).length;
  const confirmados = alertData.filter(a => a.sending_chat === true).length;

  const tempoExpirado = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining < 0;
  }).length;

  const dezMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining >= 0 && timeRemaining <= 10;
  }).length;

  const cincoMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining >= 0 && timeRemaining <= 5;
  }).length;

  const comOperador = alertData.filter(a => a.acionado === 'OK').length;
  const cenariosCrise = alertData.filter(a => a.severidade_chamado === '1' || a.severidade_chamado === '2').length;

  return (
    <div className="flex flex-col gap-2 w-full">
      <CompactCard
        title="Total"
        count={total}
        totalCount={alertData.length}
        icon={BarChart3}
        type="total"
        filterKey="TOTAL"
        isActive={activeFilter === 'TOTAL'}
        onClick={() => handleCardClick('TOTAL')}
      />

      <CompactCard
        title="CenÃ¡rios de Crise"
        count={cenariosCrise}
        totalCount={alertData.length}
        icon={AlertCircle}
        type="cenarios-crise"
        filterKey="CENARIOS_CRISE"
        isActive={activeFilter === 'CENARIOS_CRISE'}
        onClick={() => handleCardClick('CENARIOS_CRISE')}
      />

      <CompactCard
        title="Tempo Expirado"
        count={tempoExpirado}
        totalCount={alertData.length}
        icon={AlertTriangle}
        type="tempo-expirado"
        filterKey="TEMPO_EXPIRADO"
        isActive={activeFilter === 'TEMPO_EXPIRADO'}
        onClick={() => handleCardClick('TEMPO_EXPIRADO')}
      />

      <CompactCard
        title="Pendente Envio Chat"
        count={pendenteEnvioChat}
        totalCount={alertData.length}
        icon={MessageCircle}
        type="pendente-chat"
        filterKey="PENDENTE_ENVIO_CHAT"
        isActive={activeFilter === 'PENDENTE_ENVIO_CHAT'}
        onClick={() => handleCardClick('PENDENTE_ENVIO_CHAT')}
      />

      <CompactCard
        title="5min Restantes"
        count={cincoMinutosRestantes}
        totalCount={alertData.length}
        icon={Timer}
        type="cinco-minutos"
        filterKey="CINCO_MINUTOS"
        isActive={activeFilter === 'CINCO_MINUTOS'}
        onClick={() => handleCardClick('CINCO_MINUTOS')}
      />

      <CompactCard
        title="10min Restantes"
        count={dezMinutosRestantes}
        totalCount={alertData.length}
        icon={Clock}
        type="dez-minutos"
        filterKey="DEZ_MINUTOS"
        isActive={activeFilter === 'DEZ_MINUTOS'}
        onClick={() => handleCardClick('DEZ_MINUTOS')}
      />

      <CompactCard
        title="Com Operador"
        count={comOperador}
        totalCount={alertData.length}
        icon={UserCheck}
        type="com-operador"
        filterKey="COM_OPERADOR"
        isActive={activeFilter === 'COM_OPERADOR'}
        onClick={() => handleCardClick('COM_OPERADOR')}
      />

      <CompactCard
        title="Confirmados"
        count={confirmados}
        totalCount={alertData.length}
        icon={CheckCircle2}
        type="confirmados"
        filterKey="CONFIRMADOS"
        isActive={activeFilter === 'CONFIRMADOS'}
        onClick={() => handleCardClick('CONFIRMADOS')}
      />
    </div>
  );
};

interface CompactCardProps {
  title: string;
  count: number;
  totalCount: number;
  icon: React.ComponentType<any>;
  type: string;
  filterKey: string;
  isActive: boolean;
  onClick: () => void;
}

function CompactCard({ title, count, totalCount, icon: Icon, type, isActive, onClick }: CompactCardProps) {
  const typeStyles = {
    'total': {
      bg: 'bg-blue-500/10',
      border: 'border-blue-500/30',
      text: 'text-blue-600',
      hover: 'hover:bg-blue-500/20 hover:border-blue-500/50',
      animation: '',
    },
    'pendente-chat': {
      bg: 'bg-orange-500/10',
      border: 'border-orange-500/30',
      text: 'text-orange-600',
      hover: 'hover:bg-orange-500/20 hover:border-orange-500/50',
      animation: '',
    },
    'confirmados': {
      bg: 'bg-green-500/10',
      border: 'border-green-500/30',
      text: 'text-green-600',
      hover: 'hover:bg-green-500/20 hover:border-green-500/50',
      animation: '',
    },
    'tempo-expirado': {
      bg: 'bg-red-500/10',
      border: 'border-red-500/30',
      text: 'text-red-600',
      hover: 'hover:bg-red-500/20 hover:border-red-500/50',
      animation: count > 0 ? 'animate-pulse-critical' : '',
    },
    'dez-minutos': {
      bg: 'bg-yellow-500/10',
      border: 'border-yellow-500/30',
      text: 'text-yellow-600',
      hover: 'hover:bg-yellow-500/20 hover:border-yellow-500/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'cinco-minutos': {
      bg: 'bg-amber-500/10',
      border: 'border-amber-500/30',
      text: 'text-amber-600',
      hover: 'hover:bg-amber-500/20 hover:border-amber-500/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'com-operador': {
      bg: 'bg-emerald-500/10',
      border: 'border-emerald-500/30',
      text: 'text-emerald-600',
      hover: 'hover:bg-emerald-500/20 hover:border-emerald-500/50',
      animation: '',
    },
    'cenarios-crise': {
      bg: 'bg-purple-500/10',
      border: 'border-purple-500/30',
      text: 'text-purple-600',
      hover: 'hover:bg-purple-500/20 hover:border-purple-500/50',
      animation: count > 0 ? 'animate-glow-crisis' : '',
    },
  };

  const style = typeStyles[type as keyof typeof typeStyles];

  return (
    <div
      onClick={onClick}
      className={cn(
        "p-2.5 rounded-lg border-2 cursor-pointer transition-all duration-300 hover:scale-102 relative",
        style.bg,
        style.border,
        style.hover,
        style.animation,
        isActive && "ring-2 ring-primary/50 ring-offset-1 ring-offset-background"
      )}
    >
      <div className="flex items-center justify-between gap-2">
        <div className="flex items-center gap-2 flex-1 min-w-0">
          <div className={cn("p-1.5 rounded-md bg-black/20 flex-shrink-0", style.text)}>
            <Icon size={14} />
          </div>
          
          <div className="flex-1 min-w-0">
            <div className={cn("text-[10px] font-medium uppercase tracking-wide truncate", style.text)}>
              {title}
            </div>
            <div className="text-[9px] text-muted-foreground truncate">
              {count === 0 ? "Nenhum" : `${count}/${totalCount}`}
            </div>
          </div>
        </div>

        <div className={cn("text-lg font-bold flex-shrink-0", style.text)}>
          {count}
        </div>
      </div>

      {isActive && (
        <div className="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-primary rounded-full animate-pulse" />
      )}
    </div>
  );
}
