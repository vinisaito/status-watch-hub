def handle_start_timer(event, trace, body):
    chamado = int(body["chamado"])
    level = int(body["level"])

    # Se veio duration no body, usa ele. Senão aplica regra por nível.
    if "duration" in body:
        duration = int(body["duration"])
    else:
        duration = 1200 if level == 1 else 600  # 20 min no nível 1, senão 10 min

    now = datetime.now(timezone.utc).isoformat()

    update = {
        f"level{level}_timerStart": now,
        f"level{level}_duration": duration,
        f"level{level}_status": "running"
    }

    state = update_chamado(trace, chamado, update)

    broadcast({
        "event": "startTimer",
        "chamado": chamado,
        "level": level,
        "state": state
    })

    return {
        "statusCode": 200,
        "body": json.dumps({"msg": f"Timer iniciado ({duration//60} min)"}, cls=DecimalEncoder)
    }
