def get_state(event):
    body = json.loads(event.get("body", "{}"))
    chamado = int(body.get("chamado", 0))
    connection_id = event["requestContext"]["connectionId"]
    apigw = get_apigw_client(event)

    print(f"[DEBUG] get_state chamado para {chamado} - conn={connection_id}")

    if chamado:
        response = chamados_table.get_item(Key={"chamado": chamado})
        print("[DEBUG] Item retornado do DynamoDB:", response)

        if "Item" in response:
            item = response["Item"]
            message = {
                "action": "currentState",
                "chamado": int(item["chamado"]),
                "status": item.get("status", "pendente"),
                "timerEnd": int(item["timerEnd"]),
                "serverTime": int(datetime.utcnow().timestamp())
            }
            apigw.post_to_connection(Data=to_json(message), ConnectionId=connection_id)
            return {"statusCode": 200, "body": "Estado enviado"}
        else:
            print(f"[DEBUG] Nenhum estado encontrado para chamado {chamado}")
    else:
        print("[DEBUG] Nenhum chamado especificado")

    return {"statusCode": 404, "body": "Estado nÃ£o encontrado"}





ws.onopen = () => {
  console.log("Conectado ao WebSocket");

  // Solicita o estado inicial desse chamado
  ws.send(
    JSON.stringify({
      action: "getState",
      chamado: chamadoId,   // ðŸ‘ˆ pega do props
    })
  );
};
