def on_connect(event):
    connection_id = event["requestContext"]["connectionId"]
    connections_table.put_item(
        Item={
            "connectionId": connection_id,
            "connectedAt": int(datetime.utcnow().timestamp())
        }
    )
    print(f"Conex√£o registrada: {connection_id}")

    # üîπ Buscar estado atual dos chamados e enviar para o novo cliente
    apigw = boto3.client(
        "apigatewaymanagementapi",
        endpoint_url=os.environ["WS_ENDPOINT"]
    )

    # Aqui pode ser todos os chamados ou s√≥ os que est√£o ativos
    response = chamados_table.scan()
    for item in response.get("Items", []):
        try:
            apigw.post_to_connection(
                Data=json.dumps({
                    "action": "currentState",
                    "chamado": item["chamado"],
                    "status": item.get("status", "pendente"),
                    "timerStart": item.get("timerStart")
                }),
                ConnectionId=connection_id
            )
        except Exception as e:
            print(f"Erro ao enviar estado inicial: {e}")

    return {"statusCode": 200, "body": "Connected"}




if (data.action === "currentState" && data.chamado === chamado) {
  if (data.timerStart) {
    setTimerStart(data.timerStart);
  }
  if (data.status) {
    setStatus(data.status);
  }
}
