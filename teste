def on_connect(event):
    connection_id = event["requestContext"]["connectionId"]
    connections_table.put_item(
        Item={
            "connectionId": connection_id,
            "connectedAt": int(datetime.utcnow().timestamp())
        }
    )
    print(f"[DEBUG] Conex√£o registrada: {connection_id}")

    # Envia estado atual dos chamados para o novo cliente
    apigw = boto3.client(
        "apigatewaymanagementapi",
        endpoint_url=os.environ["WS_ENDPOINT"]
    )
    response = chamados_table.scan()
    print(f"[DEBUG] Estado atual: {response.get('Items', [])}")

    for item in response.get("Items", []):
        try:
            message = {
                "action": "currentState",
                "chamado": int(item["chamado"]),
                "status": str(item.get("status", "pendente")),
                "timerStart": int(item["timerStart"]) if "timerStart" in item else None
            }
            print(f"[DEBUG] Enviando estado inicial para {connection_id}: {message}")
            apigw.post_to_connection(
                Data=to_json(message),
                ConnectionId=connection_id
            )
        except Exception as e:
            print(f"Erro ao enviar estado inicial: {e}")

    return {"statusCode": 200, "body": "Connected"}
