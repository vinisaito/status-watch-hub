def handle_update_level_status(event, trace, body):
    chamado = int(body["chamado"])
    from_level = int(body["fromLevel"])
    to_level = int(body["toLevel"])
    now = datetime.now(timezone.utc).isoformat()

    check_cooldown(chamado)

    update = {
        f"level{from_level}_status": "finished",
        f"level{from_level}_updatedAt": now,
        f"level{to_level}_status": "running",
        f"level{to_level}_updatedAt": now,
        "lastActionAt": now,
    }

    state = update_chamado(trace, chamado, update)
    broadcast({"event": "updateLevelStatus", "chamado": chamado, "state": state})
    return {"statusCode": 200, "body": json.dumps({"msg": f"Chamado escalado de {from_level} para {to_level}"}, cls=DecimalEncoder)}


def handle_update_status_final(event, trace, body):
    chamado = int(body["chamado"])
    level = int(body["level"])  # <- sempre precisa vir
    now = datetime.now(timezone.utc).isoformat()

    check_cooldown(chamado)

    update = {
        f"level{level}_status": "finished",
        f"level{level}_updatedAt": now,
        "statusFinal": "finished",
        "statusFinal_updatedAt": now,
        "lastActionAt": now,
    }

    state = update_chamado(trace, chamado, update)
    broadcast({"event": "updateStatusFinal", "chamado": chamado, "state": state})
    return {"statusCode": 200, "body": json.dumps({"msg": f"Chamado finalizado no level {level}"}, cls=DecimalEncoder)})
