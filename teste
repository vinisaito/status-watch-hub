import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  ChevronDown,
  Eye,
  Calendar,
  User,
  AlertCircle,
  Clock,
  CheckCircle2,
  AlertTriangle,
  Circle,
  Settings,
  XCircle,
  RotateCcw,
  Play,
  Star,
  Plus,
  Save,
  X
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription
} from '@/components/ui/dialog';
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import { useToast } from '@/hooks/use-toast';

interface RDM {
  id: string;
  numero_rdm: number;
  descricao_rdm_user: string;
  executor: string;
  status_rdm: string;
  impacto: string;
  risco: string;
  ambiente: string;
  requisitante: string;
  ["gerente requisitante"]: string;
  depto_gerencia_requisitante: string;
  origem: string;
  warroom_preventivo: string;
  ic_rdm: string;
  tipo_rdm: 'Urgente' | 'Padr√£o' | 'Normal' | 'Informativa';
  data_inicio_programacao: string;
  data_fim_programacao?: string;
  description: string;
  grupo_executor: string;
  area_principal_afetada: string;
  ["dura√ß√£o da Programa√ß√£o"]?: string;
  status_acompanhamento?: string;
  sala_acompanhamento: string;
}

interface RDMFormData {
  numero_rdm: string;
  descricao_rdm_user: string;
  executor: string;
  status_rdm: string;
  impacto: string;
  risco: string;
  ambiente: string;
  requisitante: string;
  "gerente requisitante": string;
  depto_gerencia_requisitante: string;
  origem: string;
  warroom_preventivo: string;
  ic_rdm: string;
  tipo_rdm: 'Urgente' | 'Padr√£o' | 'Normal' | 'Informativa';
  data_inicio_programacao: string;
  data_fim_programacao: string;
  description: string;
  grupo_executor: string;
  area_principal_afetada: string;
  sala_acompanhamento: string,
  indisponibilidade: string,
  alert_incdent: string,
  atividade_teste: string,
  atividade_teste_obs: string,
  atividade_teste_anexo: File | null,
  observacoes: string,
  "dura√ß√£o da Programa√ß√£o": string;
}

const statusAcompanhamentoOptions = [
  { value: 'Adicionado para Acompanhamento', label: 'Adicionado para Acompanhamento', icon: Eye },
  { value: 'Aguardando Inicio', label: 'Em Andamento', icon: Clock },
  { value: 'Em Execu√ß√£o', label: 'Aguardando Aprova√ß√£o', icon: Play },
  { value: 'Fase de Teste', label: 'Fase de Teste', icon: Settings },
  { value: 'Conclu√≠do', label: 'Conclu√≠do', icon: CheckCircle2 },
  { value: 'Cancelado', label: 'Cancelado', icon: XCircle },
  { value: 'Rollback', label: 'Rollback', icon: RotateCcw }
];

const formatDateRange = (start: string, end?: string) => {
  if (!start) return "";

  const startDate = new Date(start);
  const endDate = end ? new Date(end) : null;

  const formatDate = (date: Date) =>
    date.toLocaleString("pt-BR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });

  return endDate ? `${formatDate(startDate)} - ${formatDate(endDate)}` : formatDate(startDate);
};

const getStatusAcompanhamentoColor = (status: string) => {
  switch (status) {
    case 'Conclu√≠do':
      return 'bg-status-completed text-white';
    case 'Em Andamento':
    case 'Em Teste':
      return 'bg-status-in-progress text-white';
    case 'Aguardando Aprova√ß√£o':
    case 'Aguardando Terceiros':
      return 'bg-status-pending text-white';
    case 'Cancelado':
      return 'bg-status-cancelled text-white';
    case 'Suspenso':
      return 'bg-status-on-hold text-white';
    default:
      return 'bg-muted text-muted-foreground';
  }
};

export const RDMTracker = () => {
  const [expandedRDM, setExpandedRDM] = useState<string | null>(null);
  const [selectedRDM, setSelectedRDM] = useState<RDM | null>(null);
  const [rdms, setRdms] = useState<RDM[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showForm, setShowForm] = useState(false);
  const [editingStatus, setEditingStatus] = useState<string | null>(null);
  const [statusLoading, setStatusLoading] = useState<string | null>(null);
  const { toast } = useToast();
  const [lookupLoading, setLookupLoading] = useState<boolean>(false);

  // Form state
  const [formData, setFormData] = useState<RDMFormData>({
    numero_rdm: '',
    descricao_rdm_user: '',
    executor: '',
    status_rdm: 'Aberta',
    impacto: '',
    risco: '',
    ambiente: '',
    requisitante: '',
    "gerente requisitante": '',
    depto_gerencia_requisitante: '',
    origem: '',
    warroom_preventivo: '',
    ic_rdm: '',
    tipo_rdm: 'Normal',
    data_inicio_programacao: '',
    data_fim_programacao: '',
    description: '',
    grupo_executor: '',
    area_principal_afetada: '',
    sala_acompanhamento: '',
    indisponibilidade: '',
    alert_incdent: '',
    atividade_teste: '',
    atividade_teste_obs: '',
    atividade_teste_anexo: null,
    observacoes: '',
    "dura√ß√£o da Programa√ß√£o": ''
  });

  // üîπ Substitua pela URL do seu API Gateway 
  const API_URL = "https://f6ffk8e9fe.execute-api.us-east-1.amazonaws.com/prod/acompanhamentordms";

  useEffect(() => {
    const fetchRDMs = async () => {
      try {
        setLoading(true);
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error(`Erro ${response.status}: N√£o foi poss√≠vel carregar as RDMs`);
        }
        const data = await response.json();
        // Garante um id est√°vel (usa numero_rdm) e adiciona status padr√£o
        const rdmsWithTrackingStatus = (data as any[]).map((rdm: any) => ({
          ...rdm,
          id: String(rdm.id ?? rdm.numero_rdm),
          status_acompanhamento: rdm.status_acompanhamento || 'N√£o Iniciado'
        })) as RDM[];
        setRdms(rdmsWithTrackingStatus);
      } catch (err: any) {
        setError(err.message || "Erro desconhecido");
      } finally {
        setLoading(false);
      }
    };

    fetchRDMs();
  }, []);

  // Helper: format ISO/string date to yyyy-MM-ddTHH:mm for input[type=datetime-local]
  const toInputDateTime = (value?: string | null) => {
    if (!value) return '';
    try {
      const d = new Date(value);
      if (isNaN(d.getTime())) return '';
      const pad = (n: number) => String(n).padStart(2, '0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    } catch {
      return '';
    }
  };

  // Fetch a single RDM by number and hydrate form
  const fetchRdmByNumber = async (numero: string) => {
    const trimmed = (numero || '').trim();
    if (!trimmed) return;
    setLookupLoading(true);
    try {
      const res = await fetch(`${API_URL}?numero_rdm=${encodeURIComponent(trimmed)}`);
      if (res.status === 404) {
        toast({
          title: 'RDM n√£o encontrada',
          description: `N√£o localizamos a RDM ${trimmed}. Verifique o n√∫mero e tente novamente.`,
        });
        return;
      }
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Falha ao consultar a RDM');
      }
      const data = await res.json();

      // Map API fields to form structure, preserving any user edits not provided by API
      setFormData(prev => ({
        ...prev,
        numero_rdm: String(data.numero_rdm ?? trimmed),
        descricao_rdm_user: data.descricao_rdm_user ?? prev.descricao_rdm_user ?? '',
        executor: data.executor ?? prev.executor ?? '',
        status_rdm: data.status_rdm ?? prev.status_rdm ?? 'Aberta',
        impacto: data.impacto ?? prev.impacto ?? '',
        risco: data.risco ?? prev.risco ?? '',
        ambiente: data.ambiente ?? prev.ambiente ?? '',
        requisitante: data.requisitante ?? prev.requisitante ?? '',
        "gerente requisitante": data["gerente requisitante"] ?? prev["gerente requisitante"] ?? '',
        depto_gerencia_requisitante: data.depto_gerencia_requisitante ?? prev.depto_gerencia_requisitante ?? '',
        origem: data.origem ?? prev.origem ?? '',
        warroom_preventivo: data.warroom_preventivo ?? prev.warroom_preventivo ?? '',
        ic_rdm: data.ic_rdm ?? prev.ic_rdm ?? '',
        tipo_rdm: data.tipo_rdm ?? prev.tipo_rdm ?? 'Normal',
        data_inicio_programacao: toInputDateTime(data.data_inicio_programacao) || prev.data_inicio_programacao || '',
        data_fim_programacao: toInputDateTime(data.data_fim_programacao) || prev.data_fim_programacao || '',
        description: data.description ?? prev.description ?? '',
        grupo_executor: data.grupo_executor ?? prev.grupo_executor ?? '',
        area_principal_afetada: data.area_principal_afetada ?? prev.area_principal_afetada ?? '',
        sala_acompanhamento: prev.sala_acompanhamento ?? '',
        indisponibilidade: prev.indisponibilidade ?? '',
        alert_incdent: prev.alert_incdent ?? '',
        atividade_teste: prev.atividade_teste ?? '',
        atividade_teste_obs: prev.atividade_teste_obs ?? '',
        atividade_teste_anexo: prev.atividade_teste_anexo ?? null,
        observacoes: prev.observacoes ?? '',
        "dura√ß√£o da Programa√ß√£o": data["dura√ß√£o da Programa√ß√£o"] ?? prev["dura√ß√£o da Programa√ß√£o"] ?? '',
      }));

      toast({
        title: 'Dados preenchidos',
        description: `Campos carregados para a RDM ${trimmed}.`,
      });
    } catch (err: any) {
      toast({
        title: 'Falha no autocomplete',
        description: err?.message || 'Erro ao consultar a API.',
        variant: 'destructive',
      });
    } finally {
      setLookupLoading(false);
    }
  };

  const handleCreateRDM = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      // Atualiza/Registra status de acompanhamento no backend
      const payload = {
        numero_rdm: String(formData.numero_rdm).trim(),
        status_acompanhamento: 'Adicionado para Acompanhamento'
      };

      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const msg = await response.text();
        throw new Error(msg || 'Erro ao criar RDM');
      }

      // Prepara objeto local (fallback) caso a busca pontual n√£o retorne
      const newRDM = {
        // Dados principais vindos do formul√°rio
        id: String(formData.numero_rdm).trim(),
        numero_rdm: parseInt(formData.numero_rdm),
        descricao_rdm_user: formData.descricao_rdm_user,
        executor: formData.executor,
        status_rdm: formData.status_rdm,
        impacto: formData.impacto,
        risco: formData.risco,
        ambiente: formData.ambiente,
        requisitante: formData.requisitante,
        ["gerente requisitante"]: formData["gerente requisitante"],
        depto_gerencia_requisitante: formData.depto_gerencia_requisitante,
        origem: formData.origem,
        warroom_preventivo: formData.warroom_preventivo,
        ic_rdm: formData.ic_rdm,
        tipo_rdm: formData.tipo_rdm,
        data_inicio_programacao: formData.data_inicio_programacao,
        data_fim_programacao: formData.data_fim_programacao || undefined,
        description: formData.description,
        grupo_executor: formData.grupo_executor,
        area_principal_afetada: formData.area_principal_afetada,
        ["dura√ß√£o da Programa√ß√£o"]: formData["dura√ß√£o da Programa√ß√£o"] || undefined,
        status_acompanhamento: 'Adicionado para Acompanhamento',
        sala_acompanhamento: formData.sala_acompanhamento,
      } as RDM;
      // Tenta buscar a RDM salva do backend e fazer upsert na lista
      const numeroStr = String(formData.numero_rdm).trim();
      try {
        const r = await fetch(`${API_URL}?numero_rdm=${encodeURIComponent(numeroStr)}`);
        if (r.ok) {
          const apiRdm = await r.json();
          const mapped: RDM = {
            ...(apiRdm as any),
            id: String((apiRdm as any).id ?? (apiRdm as any).numero_rdm),
            status_acompanhamento: (apiRdm as any).status_acompanhamento || 'Adicionado para Acompanhamento',
          };
          setRdms(prev => {
            const idx = prev.findIndex(x => String(x.numero_rdm) === String(mapped.numero_rdm));
            if (idx >= 0) {
              const copy = [...prev];
              copy[idx] = { ...copy[idx], ...mapped };
              return copy;
            }
            return [mapped, ...prev];
          });
        } else {
          // 404 ou outro erro: mant√©m o fallback local
          setRdms(prev => [newRDM, ...prev]);
        }
      } catch {
        setRdms(prev => [newRDM, ...prev]);
      }
      toast({
        title: "RDM criada com sucesso!",
        description: `RDM ${formData.numero_rdm} foi cadastrada.`,
      });
      handleCloseForm();
    } catch (error) {
      toast({
        title: "Erro ao criar RDM",
        description: "Ocorreu um erro ao cadastrar a RDM. Tente novamente.",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleStatusChange = async (rdmId: string, newStatus: string) => {
    setStatusLoading(rdmId);
    try {
      // Atualiza status no backend (Lambda aceita POST)
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ numero_rdm: String(rdmId), status_acompanhamento: newStatus })
      });

      if (!response.ok) {
        const msg = await response.text();
        throw new Error(msg || 'Erro ao atualizar status');
      }

      setRdms(prev => prev.map(rdm =>
        rdm.id === rdmId
          ? { ...rdm, status_acompanhamento: newStatus }
          : rdm
      ));

      if (selectedRDM?.id === rdmId) {
        setSelectedRDM(prev => prev ? { ...prev, status_acompanhamento: newStatus } : null);
      }

      toast({
        title: "Status atualizado!",
        description: `Status alterado para: ${newStatus}`,
      });
      setEditingStatus(null);
    } catch (error) {
      toast({
        title: "Erro ao atualizar status",
        description: "Ocorreu um erro. Tente novamente.",
        variant: "destructive",
      });
    } finally {
      setStatusLoading(null);
    }
  };

  const handleCloseForm = () => {
    setFormData({
      numero_rdm: '',
      descricao_rdm_user: '',
      executor: '',
      status_rdm: 'Aberta',
      impacto: '',
      risco: '',
      ambiente: '',
      requisitante: '',
      "gerente requisitante": '',
      depto_gerencia_requisitante: '',
      origem: '',
      warroom_preventivo: '',
      ic_rdm: '',
      tipo_rdm: 'Normal',
      data_inicio_programacao: '',
      data_fim_programacao: '',
      description: '',
      grupo_executor: '',
      area_principal_afetada: '',
      sala_acompanhamento: '',
      indisponibilidade: '',
      alert_incdent: '',
      atividade_teste: '',
      atividade_teste_obs: '',
      atividade_teste_anexo: null,
      observacoes: '',
      "dura√ß√£o da Programa√ß√£o": ''
    });
    setShowForm(false);
  };

  const updateFormData = (field: keyof RDMFormData, value: string | File | null) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const getStatusBadgeClass = (status_rdm: string) => {
    switch (status_rdm) {
      case 'Aberta':
      case 'Aprovada':
        return 'bg-status-approved text-white border-status-approved/50 shadow-md';

      case 'Cancelada':
      case 'Rejeitada':
        return 'bg-status-cancelled text-white border-status-cancelled/50 shadow-md';

      case 'Em aprova√ß√£o':
      case 'Em aprova√ß√£o - Comit√™':
        return 'bg-status-pending text-white border-status-pending/50 shadow-md';

      case 'Em implanta√ß√£o':
        return 'bg-status-in-progress text-white border-status-in-progress/50 shadow-md';

      case 'Implantada':
      case 'Fechada':
        return 'bg-status-completed text-white border-status-completed/50 shadow-md';

      case 'Plano de volta em execu√ß√£o':
      case 'Recuada':
        return 'bg-status-on-hold text-white border-status-on-hold/50 shadow-md';

      default:
        return 'bg-muted text-muted-foreground';
    }
  };

  const getStatusText = (status_rdm: string) => {
    switch (status_rdm) {
      case 'Aberta':
        return 'Aberta';
      case 'Aprovada':
        return 'Aprovada';
      case 'Cancelada':
        return 'Cancelada';
      case 'Em aprova√ß√£o':
        return 'Em aprova√ß√£o';
      case 'Em aprova√ß√£o - Comit√™':
        return 'Em aprova√ß√£o - Comit√™';
      case 'Em implanta√ß√£o':
        return 'Em implanta√ß√£o';
      case 'Fechada':
        return 'Fechada';
      case 'Implantada':
        return 'Implantada';
      case 'Plano de volta em execu√ß√£o':
        return 'Plano de volta em execu√ß√£o';
      case 'Recuada':
        return 'Recuada';
      case 'Rejeitada':
        return 'Rejeitada';
      default:
        return 'Desconhecido';
    }
  };

  const getStatusIcon = (status_rdm: string) => {
    switch (status_rdm) {
      case 'Aberta':
        return <Play className="h-4 w-4 animate-pulse" />;
      case 'Aprovada':
        return <Star className="h-4 w-4 animate-bounce" />;

      case 'Cancelada':
      case 'Rejeitada':
        return <XCircle className="h-4 w-4" />;

      case 'Em implanta√ß√£o':
        return <Settings className="h-4 w-4 animate-spin" />;

      case 'Em aprova√ß√£o':
      case 'Em aprova√ß√£o - Comit√™':
        return <Clock className="h-4 w-4 animate-bounce" />;

      case 'Implantada':
      case 'Fechada':
        return <CheckCircle2 className="h-4 w-4" />;

      case 'Plano de volta em execu√ß√£o':
      case 'Recuada':
        return <RotateCcw className="h-4 w-4" />;

      default:
        return <Circle className="h-4 w-4" />;
    }
  };

  const getPriorityIcon = (tipo_rdm: string) => {
    switch (tipo_rdm) {
      case 'Urgente':
        return <AlertTriangle className="h-4 w-4 text-status-cancelled" />;
      case 'Padr√£o':
      case 'Normal':
        return <AlertCircle className="h-4 w-4 text-status-in-progress" />;
      case 'Informativa':
        return <Circle className="h-4 w-4 text-status-completed" />;
      default:
        return <Circle className="h-4 w-4 text-muted-foreground" />;
    }
  };

  const getPriorityColor = (tipo_rdm: string) => {
    switch (tipo_rdm) {
      case 'Urgente':
        return 'text-status-cancelled';
      case 'Padr√£o':
      case 'Normal':
        return 'text-status-in-progress';
      case 'Informativa':
        return 'text-status-completed';
      default:
        return 'text-muted-foreground';
    }
  };

  const getPriorityText = (tipo_rdm: string) => {
    return tipo_rdm;
  };

  const toggleExpanded = (id: string) => {
    setExpandedRDM(prev => prev === id ? null : id);
  };

  const openModal = (rdm: RDM) => {
    setSelectedRDM(rdm);
  };

  const closeModal = () => {
    setSelectedRDM(null);
  };

  const activeRDMs = rdms.filter(rdm => rdm.status_rdm !== 'Fechada' && rdm.status_rdm !== 'Implantada').length;

  // Componente StatusSelector inline
  const StatusSelector = ({ rdm }: { rdm: RDM }) => {
    const [selectedStatus, setSelectedStatus] = useState(rdm.status_acompanhamento || 'N√£o Iniciado');
    const isEditing = editingStatus === rdm.id;
    const isLoading = statusLoading === rdm.id;

    const currentStatusOption = statusAcompanhamentoOptions.find(option => option.value === selectedStatus) || statusAcompanhamentoOptions[0];
    const CurrentIcon = currentStatusOption.icon;

    if (!isEditing) {
      return (
        <div className="flex items-center gap-2">
          <Badge className={`${getStatusAcompanhamentoColor(selectedStatus)} flex items-center gap-1.5 px-3 py-1`}>
            <CurrentIcon className="h-3 w-3" />
            {selectedStatus}
          </Badge>
          <Button
            variant="outline"
            size="sm"
            onClick={() => setEditingStatus(rdm.id)}
            className="h-8 px-2 text-xs"
            disabled={isLoading}
          >
            Alterar
          </Button>
        </div>
      );
    }

    return (
      <div className="flex items-center gap-2 p-2 bg-accent/10 rounded-lg border">
        <div className="flex-1">
          <Select value={selectedStatus} onValueChange={setSelectedStatus}>
            <SelectTrigger className="h-8">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {statusAcompanhamentoOptions.map((option) => {
                const Icon = option.icon;
                return (
                  <SelectItem key={option.value} value={option.value}>
                    <div className="flex items-center gap-2">
                      <Icon className="h-4 w-4" />
                      {option.label}
                    </div>
                  </SelectItem>
                );
              })}
            </SelectContent>
          </Select>
        </div>
        <div className="flex gap-1">
          <Button
            size="sm"
            onClick={() => handleStatusChange(rdm.id, selectedStatus)}
            disabled={isLoading || selectedStatus === rdm.status_acompanhamento}
            className="h-8 px-2"
          >
            <Save className="h-3 w-3" />
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => {
              setSelectedStatus(rdm.status_acompanhamento || 'N√£o Iniciado');
              setEditingStatus(null);
            }}
            disabled={isLoading}
            className="h-8 px-2"
          >
            ‚úï
          </Button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-background p-6">
      <Card className="shadow-card border transition-all duration-300 hover:shadow-hover">
        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-3">
          <CardTitle className="text-primary flex items-center gap-3 text-xl font-bold">
            <div className="relative">
              <Calendar className="h-6 w-6" />
              {activeRDMs > 0 && (
                <div className="absolute -top-1 -right-1 w-3 h-3 bg-status-in-progress rounded-full animate-pulse border border-background" />
              )}
            </div>
            <span>Acompanhamento de RDMs</span>
            {activeRDMs > 0 && (
              <Badge variant="outline" className="ml-2 px-2 py-1 bg-status-in-progress/10 text-status-in-progress border-status-in-progress/30">
                {activeRDMs} ativas
              </Badge>
            )}
          </CardTitle>
          <Button
            variant="default"
            size="sm"
            className="bg-primary hover:bg-primary/90"
            onClick={() => setShowForm(true)}
          >
            <Plus className="h-4 w-4 mr-2" />
            Adicionar RDM
          </Button>
        </CardHeader>

        <CardContent className="space-y-3 max-h-[75vh] overflow-y-auto pr-2">
          {loading && (
            <div className="text-center py-8 text-muted-foreground">
              Carregando RDMs...
            </div>
          )}

          {error && (
            <div className="text-center py-8 text-status-cancelled">
              {error}
            </div>
          )}

          {!loading && !error && rdms.map((rdm, index) => (
            <div
              key={rdm.id}
              className="group relative border rounded-xl p-4 bg-card hover:bg-accent/5 transition-all duration-300 shadow-sm hover:shadow-card animate-in fade-in-0 slide-in-from-bottom-4"
              style={{ animationDelay: `${index * 100}ms` }}
            >
              {/* Priority indicator */}
              <div className={`absolute left-0 top-4 bottom-4 w-1 rounded-r-lg transition-all duration-300 ${rdm.tipo_rdm === 'Urgente' ? 'bg-status-cancelled' :
                rdm.tipo_rdm === 'Normal' || rdm.tipo_rdm === 'Padr√£o' ? 'bg-status-in-progress' :
                  rdm.tipo_rdm === 'Informativa' ? 'bg-status-completed' : 'bg-muted'
                }`} />

              <div className="flex flex-col gap-4 ml-4">
                {/* Header with RDM info */}
                <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                  <div className="flex items-center gap-3 flex-wrap">
                    <span className="font-mono text-sm bg-accent/30 px-2 py-1 rounded-md text-accent-foreground font-semibold">
                      #{rdm.numero_rdm}
                    </span>
                    <span className="text-sm text-foreground font-medium break-words max-w-[300px]">
                      {rdm.descricao_rdm_user}
                    </span>
                    <span className="text-sm text-muted-foreground font-medium">
                      {rdm.grupo_executor}
                    </span>
                  </div>

                  <div className="flex items-center gap-3">
                    <Badge className={`${getStatusBadgeClass(rdm.status_rdm)} flex items-center gap-1.5 px-3 py-1`}>
                      {getStatusIcon(rdm.status_rdm)}
                      {getStatusText(rdm.status_rdm)}
                    </Badge>
                    <Button
                      variant="outline"
                      size="sm"
                      className="hover:bg-accent/50 transition-all duration-300"
                      onClick={() => openModal(rdm)}
                    >
                      Detalhes
                    </Button>
                  </div>
                </div>

                {/* Status de Acompanhamento */}
                <div className="flex items-center gap-3 p-3 bg-accent/10 rounded-lg border border-accent/20">
                  <div className="flex items-center gap-2 text-sm font-medium text-foreground">
                    <Settings className="h-4 w-4" />
                    Status de Acompanhamento:
                  </div>
                  <StatusSelector rdm={rdm} />
                </div>
              </div>
            </div>
          ))}

          {!loading && !error && rdms.length === 0 && (
            <div className="text-center py-12 animate-in fade-in-0">
              <Calendar className="h-12 w-12 text-muted-foreground mx-auto mb-4 opacity-50" />
              <p className="text-muted-foreground text-lg font-medium">
                Nenhuma RDM cadastrada
              </p>
              <p className="text-muted-foreground/70 text-sm mt-1">
                Clique em "Adicionar RDM" para come√ßar
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Form Modal */}
      <Dialog open={showForm} onOpenChange={(open) => {
        if (open) {
          setShowForm(true);
        } else {
          handleCloseForm();
        }
      }}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-3 text-xl">
              <div className="p-2 rounded-lg bg-primary/10">
                <Calendar className="h-5 w-5 text-primary" />
              </div>
              Nova RDM
            </DialogTitle>
          </DialogHeader>

          <form onSubmit={handleCreateRDM} className="space-y-6 py-4">
            {/* Basic Information */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="numero_rdm">N√∫mero RDM *</Label>
                <div className="relative">
                  <Input
                    id="numero_rdm"
                    value={formData.numero_rdm}
                    onChange={(e) => updateFormData('numero_rdm', e.target.value)}
                    onBlur={(e) => fetchRdmByNumber(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.preventDefault();
                        fetchRdmByNumber((e.target as HTMLInputElement).value);
                      }
                    }}
                    placeholder="Ex: 12345"
                    required
                  />
                  {lookupLoading && (
                    <div className="absolute inset-y-0 right-2 flex items-center text-muted-foreground text-xs">
                      Buscando...
                    </div>
                  )}
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="tipo_rdm">Tipo RDM *</Label>
                <Select value={formData.tipo_rdm} onValueChange={(value) => updateFormData('tipo_rdm', value as any)}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Urgente">Urgente</SelectItem>
                    <SelectItem value="Padr√£o">Padr√£o</SelectItem>
                    <SelectItem value="Normal">Normal</SelectItem>
                    <SelectItem value="Informativa">Informativa</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="status_rdm">Status *</Label>
              <Select value={formData.status_rdm} onValueChange={(value) => updateFormData('status_rdm', value as any)}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="Aberta">Aberta</SelectItem>
                  <SelectItem value="Agendada">Agendada</SelectItem>
                  <SelectItem value="Aprovada">Aprovada</SelectItem>
                  <SelectItem value="Cancelada">Cancelada</SelectItem>
                  <SelectItem value="Em aprova√ß√£o">Em aprova√ß√£o</SelectItem>
                  <SelectItem value="Em aprova√ß√£o - Comit√™">Em aprova√ß√£o - Comit√™</SelectItem>
                  <SelectItem value="Em avalia√ß√£o">Em avalia√ß√£o</SelectItem>
                  <SelectItem value="Em implanta√ß√£o">Em implanta√ß√£o</SelectItem>
                  <SelectItem value="Em Verifica√ß√£o">Em Verifica√ß√£o</SelectItem>
                  <SelectItem value="Fechada">Fechada</SelectItem>
                  <SelectItem value="Implantada">Implantada</SelectItem>
                  <SelectItem value="Plano de volta em execu√ß√£o">Plano de volta em execu√ß√£o</SelectItem>
                  <SelectItem value="Recuada">Recuada</SelectItem>
                  <SelectItem value="Rejeitada">Rejeitada</SelectItem>
                  <SelectItem value="Valida√ß√£o Automa√ß√£o">Valida√ß√£o Automa√ß√£o</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="descricao_rdm_user">Descri√ß√£o *</Label>
              <Textarea
                id="descricao_rdm_user"
                value={formData.descricao_rdm_user}
                onChange={(e) => updateFormData('descricao_rdm_user', e.target.value)}
                placeholder="T√≠tulo da Mudan√ßa"
                rows={3}
                required
              />
            </div>

            {/* Responsible Information */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="executor">Executor *</Label>
                <Input
                  id="executor"
                  value={formData.executor}
                  onChange={(e) => updateFormData('executor', e.target.value)}
                  placeholder="Nome do respons√°vel"
                  required
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="grupo_executor">Grupo Executor *</Label>
                <Input
                  id="grupo_executor"
                  value={formData.grupo_executor}
                  onChange={(e) => updateFormData('grupo_executor', e.target.value)}
                  placeholder="Equipe respons√°vel"
                  required
                />
              </div>
            </div>

            {/* Environment and Risk */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="area_principal_afetada">√Årea Principal Afetada</Label>
                <Input
                  id="area_principal_afetada"
                  value={formData.area_principal_afetada}
                  onChange={(e) => updateFormData('area_principal_afetada', e.target.value)}
                  placeholder="√Årea impactada"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="requisitante">Requisitante</Label>
                <Input
                  id="requisitante"
                  value={formData.requisitante}
                  onChange={(e) => updateFormData('requisitante', e.target.value)}
                  placeholder="Nome do solicitante"
                />
              </div>
            </div>

            {/* Scheduling */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="data_inicio_programacao">Data/Hora In√≠cio *</Label>
                <Input
                  id="data_inicio_programacao"
                  type="datetime-local"
                  value={formData.data_inicio_programacao}
                  onChange={(e) => updateFormData('data_inicio_programacao', e.target.value)}
                  required
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="data_fim_programacao">Data/Hora Fim</Label>
                <Input
                  id="data_fim_programacao"
                  type="datetime-local"
                  value={formData.data_fim_programacao}
                  onChange={(e) => updateFormData('data_fim_programacao', e.target.value)}
                />
              </div>
            </div>

            {/* Additional Information */}
            <div className="grid grid-cols-1 md:grid-cols-1 gap-4">
              <div className="space-y-2">
                <Label htmlFor="sala_acompanhamento">Sala de Acompanhamento</Label>
                <Input
                  id="sala_acompanhamento"
                  value={formData.sala_acompanhamento}
                  onChange={(e) => updateFormData('sala_acompanhamento', e.target.value)}
                  placeholder="Sala de Acompanhamento"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="indisponibilidade">Indisponibilidade Prevista</Label>
                <Input
                  id="indisponibilidade"
                  value={formData.indisponibilidade}
                  onChange={(e) => updateFormData('indisponibilidade', e.target.value)}
                  placeholder="Indisponibilidade Prevista"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="alert_incdent">Alertas e Incidentes</Label>
                <Input
                  id="alert_incdent"
                  value={formData.alert_incdent}
                  onChange={(e) => updateFormData('alert_incdent', e.target.value)}
                  placeholder="Alertas e Incidentes"
                />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="atividade_teste">Atividade de Teste</Label>
              <Select value={formData.atividade_teste} onValueChange={(value) => updateFormData('atividade_teste', value)}>
                <SelectTrigger>
                  <SelectValue placeholder="Selecione" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="Aguardando fase de teste">Aguardando fase de teste</SelectItem>
                  <SelectItem value="Teste confirmado pelo respons√°vel">Teste confirmado pelo respons√°vel</SelectItem>
                  <SelectItem value="Teste n√£o confirmado pelo respons√°vel">Teste n√£o confirmado pelo respons√°vel</SelectItem>
                </SelectContent>
              </Select>
            </div>
            {formData.atividade_teste === "Teste confirmado pelo respons√°vel" && (
              <div className="grid grid-cols-1 md:grid-cols-1 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="atividade_teste_obs">Atividade de Teste - Observa√ß√µes *</Label>
                  <Input
                    id="atividade_teste_obs"
                    value={formData.atividade_teste_obs || ""}
                    onChange={(e) => updateFormData("atividade_teste_obs", e.target.value)}
                    placeholder="Observa√ß√µes da Atividade"
                    required
                  />
                </div>

                <div className="space-y-2 col-span-2">
                  <Label htmlFor="atividade_teste_anexo">Atividade de Teste - Anexo</Label>
                  <Input
                    id="atividade_teste_anexo"
                    type="file"
                    accept=".pdf,.jpg,.png,.doc,.docx" // <-- restringe tipos aceitos
                    onChange={(e) => updateFormData("atividade_teste_anexo", e.target.files?.[0] || null)}
                  />
                  {formData.atividade_teste_anexo && (
                    <p className="text-sm text-gray-500">Arquivo selecionado: {formData.atividade_teste_anexo.name}</p>
                  )}
                </div>
              </div>
            )}
            {formData.atividade_teste === "Teste n√£o confirmado pelo respons√°vel" && (
              <div className="grid grid-cols-1 md:grid-cols-1 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="atividade_teste_obs">Atividade de Teste - Observa√ß√µes *</Label>
                  <Input
                    id="atividade_teste_obs"
                    value={formData.atividade_teste_obs || ""}
                    onChange={(e) => updateFormData("atividade_teste_obs", e.target.value)}
                    placeholder="Observa√ß√µes da Atividade"
                    required
                  />
                </div>
              </div>
            )}

            <div className="space-y-2">
              <Label htmlFor="observacoes">Observa√ß√µes</Label>
              <Textarea
                id="observacoes"
                value={formData.observacoes}
                onChange={(e) => updateFormData('observacoes', e.target.value)}
                placeholder="Observa√ß√µes da RDM"
                rows={3}
                required
              />
            </div>

            {/* Form Actions */}
            <div className="flex justify-end gap-3 pt-4 border-t">
              <Button
                type="button"
                variant="outline"
                onClick={handleCloseForm}
                disabled={loading}
              >
                <X className="h-4 w-4 mr-2" />
                Cancelar
              </Button>
              <Button
                type="submit"
                disabled={loading}
                className="bg-primary hover:bg-primary/90"
              >
                <Save className="h-4 w-4 mr-2" />
                {loading ? 'Salvando...' : 'Salvar RDM'}
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Details Modal */}
      <Dialog open={!!selectedRDM} onOpenChange={closeModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="text-xl flex items-center gap-3">
              <div className="p-2 rounded-lg bg-primary/10">
                <Calendar className="h-5 w-5 text-primary" />
              </div>
              #{selectedRDM?.numero_rdm} - {selectedRDM?.descricao_rdm_user}
            </DialogTitle>
          </DialogHeader>

          {selectedRDM && (
            <div className="space-y-6 py-4">
              {/* Status and Priority */}
              <div className="flex flex-wrap items-center gap-4">
                <Badge className={`${getStatusBadgeClass(selectedRDM.status_rdm)} flex items-center gap-2 px-3 py-2`}>
                  {getStatusIcon(selectedRDM.status_rdm)}
                  {getStatusText(selectedRDM.status_rdm)}
                </Badge>
                <div className="flex items-center gap-2">
                  {getPriorityIcon(selectedRDM.tipo_rdm)}
                  <span className={`font-semibold ${getPriorityColor(selectedRDM.tipo_rdm)}`}>
                    Prioridade {getPriorityText(selectedRDM.tipo_rdm)}
                  </span>
                </div>
              </div>

              {/* Status de Acompanhamento no Modal */}
              <div className="p-4 bg-accent/10 rounded-lg border border-accent/20">
                <h4 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                  <Settings className="h-4 w-4" />
                  Status de Acompanhamento
                </h4>
                <StatusSelector rdm={selectedRDM} />
              </div>

              {/* Details Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div className="flex items-center gap-3 p-3 bg-accent/10 rounded-lg border border-accent/20">
                    <User className="h-5 w-5 text-primary" />
                    <div>
                      <p className="text-sm text-muted-foreground">Respons√°vel</p>
                      <p className="font-semibold text-foreground">{selectedRDM.executor}</p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3 p-3 bg-accent/10 rounded-lg border border-accent/20">
                    <Settings className="h-5 w-5 text-primary" />
                    <div>
                      <p className="text-sm text-muted-foreground">Equipe</p>
                      <p className="font-semibold text-foreground">{selectedRDM.grupo_executor}</p>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="flex items-center gap-3 p-3 bg-accent/10 rounded-lg border border-accent/20">
                    <Calendar className="h-5 w-5 text-primary" />
                    <div>
                      <p className="text-sm text-muted-foreground">Janela de Execu√ß√£o</p>
                      <p className="font-semibold text-foreground">
                        {formatDateRange(selectedRDM.data_inicio_programacao, selectedRDM.data_fim_programacao)}
                      </p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3 p-3 bg-accent/10 rounded-lg border border-accent/20">
                    <Clock className="h-5 w-5 text-primary" />
                    <div>
                      <p className="text-sm text-muted-foreground">Dura√ß√£o Estimada</p>
                      <p className="font-semibold text-foreground">{selectedRDM["dura√ß√£o da Programa√ß√£o"] || 'N/A'} Horas</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Description */}
              <div className="max-w-3xl w-full max-h-[20vh] overflow-y-auto mx-auto">
                <h4 className="font-semibold text-foreground mb-4 flex items-center gap-2 text-lg">
                  <AlertCircle className="h-4 w-4" />
                  Mais informa√ß√µes
                </h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <span className="font-medium text-foreground">Ambiente:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.ambiente}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">Origem:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.origem}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">Impacto:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.impacto}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">Risco:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.risco}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">Requisitante:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.requisitante}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">√Årea Principal:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.area_principal_afetada}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">War Room Preventivo:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.warroom_preventivo}</span>
                  </div>
                  <div>
                    <span className="font-medium text-foreground">IC:</span>
                    <span className="text-muted-foreground ml-1">{selectedRDM.ic_rdm}</span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
};
