MONITORING CARds:
import { useState } from 'react';
import { AlertTriangle, AlertCircle, Clock, Timer, UserCheck, BarChart3, MessageCircle, CheckCircle2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AlertData {
  id: string;
  chamado: string;
  tipo_chamado: string;
  grupo_chamado: string;
  status_chamado: string;
  abertura_chamado: string;
  resumo_chamado: string;
  severidade_chamado: string;
  acionado: string;
  chat: boolean;
  sending_chat?: boolean;
}

interface MonitoringCardsProps {
  alertData: AlertData[];
  onFilterSelect: (filter: string | null) => void;
}

export const MonitoringCards = ({ alertData, onFilterSelect }: MonitoringCardsProps) => {
  const [activeFilter, setActiveFilter] = useState<string | null>(null);

  const handleCardClick = (filterKey: string) => {
    if (activeFilter === filterKey) {
      setActiveFilter(null);
      onFilterSelect(null);
    } else {
      setActiveFilter(filterKey);
      onFilterSelect(filterKey);
    }
  };

  const getTimeRemaining = (openingTime: string) => {
    const now = new Date();
    const opening = new Date(openingTime);
    const diffMs = now.getTime() - opening.getTime();
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const slaMinutes = 60;
    return slaMinutes - diffMinutes;
  };

  const total = alertData.length;
  const pendenteEnvioChat = alertData.filter(a => a.sending_chat === false || a.sending_chat === undefined).length;
  const confirmados = alertData.filter(a => a.sending_chat === true).length;

  const tempoExpirado = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining < 0;
  }).length;

  const dezMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining >= 0 && timeRemaining <= 10;
  }).length;

  const cincoMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining >= 0 && timeRemaining <= 5;
  }).length;

  const comOperador = alertData.filter(a => a.acionado === 'OK').length;
  const cenariosCrise = alertData.filter(a => a.severidade_chamado === '1' || a.severidade_chamado === '2').length;

  return (
    <div className="flex flex-col gap-3 w-full">
      <CompactCard
        title="Total"
        count={total}
        totalCount={alertData.length}
        icon={BarChart3}
        type="total"
        filterKey="TOTAL"
        isActive={activeFilter === 'TOTAL'}
        onClick={() => handleCardClick('TOTAL')}
      />

      <CompactCard
        title="Cenários de Crise"
        count={cenariosCrise}
        totalCount={alertData.length}
        icon={AlertCircle}
        type="cenarios-crise"
        filterKey="CENARIOS_CRISE"
        isActive={activeFilter === 'CENARIOS_CRISE'}
        onClick={() => handleCardClick('CENARIOS_CRISE')}
      />

      <CompactCard
        title="Tempo Expirado"
        count={tempoExpirado}
        totalCount={alertData.length}
        icon={AlertTriangle}
        type="tempo-expirado"
        filterKey="TEMPO_EXPIRADO"
        isActive={activeFilter === 'TEMPO_EXPIRADO'}
        onClick={() => handleCardClick('TEMPO_EXPIRADO')}
      />

      <CompactCard
        title="Pendente Envio Chat"
        count={pendenteEnvioChat}
        totalCount={alertData.length}
        icon={MessageCircle}
        type="pendente-chat"
        filterKey="PENDENTE_ENVIO_CHAT"
        isActive={activeFilter === 'PENDENTE_ENVIO_CHAT'}
        onClick={() => handleCardClick('PENDENTE_ENVIO_CHAT')}
      />

      <CompactCard
        title="5min Restantes"
        count={cincoMinutosRestantes}
        totalCount={alertData.length}
        icon={Timer}
        type="cinco-minutos"
        filterKey="CINCO_MINUTOS"
        isActive={activeFilter === 'CINCO_MINUTOS'}
        onClick={() => handleCardClick('CINCO_MINUTOS')}
      />

      <CompactCard
        title="10min Restantes"
        count={dezMinutosRestantes}
        totalCount={alertData.length}
        icon={Clock}
        type="dez-minutos"
        filterKey="DEZ_MINUTOS"
        isActive={activeFilter === 'DEZ_MINUTOS'}
        onClick={() => handleCardClick('DEZ_MINUTOS')}
      />

      <CompactCard
        title="Com Operador"
        count={comOperador}
        totalCount={alertData.length}
        icon={UserCheck}
        type="com-operador"
        filterKey="COM_OPERADOR"
        isActive={activeFilter === 'COM_OPERADOR'}
        onClick={() => handleCardClick('COM_OPERADOR')}
      />

      <CompactCard
        title="Confirmados"
        count={confirmados}
        totalCount={alertData.length}
        icon={CheckCircle2}
        type="confirmados"
        filterKey="CONFIRMADOS"
        isActive={activeFilter === 'CONFIRMADOS'}
        onClick={() => handleCardClick('CONFIRMADOS')}
      />
    </div>
  );
};

interface CompactCardProps {
  title: string;
  count: number;
  totalCount: number;
  icon: React.ComponentType<any>;
  type: string;
  filterKey: string;
  isActive: boolean;
  onClick: () => void;
}

function CompactCard({ title, count, totalCount, icon: Icon, type, isActive, onClick }: CompactCardProps) {
  const typeStyles = {
    'total': {
      bg: 'bg-blue-500/10',
      border: 'border-blue-500/30',
      text: 'text-blue-600',
      hover: 'hover:bg-blue-500/20 hover:border-blue-500/50',
      animation: '',
    },
    'pendente-chat': {
      bg: 'bg-orange-500/10',
      border: 'border-orange-500/30',
      text: 'text-orange-600',
      hover: 'hover:bg-orange-500/20 hover:border-orange-500/50',
      animation: '',
    },
    'confirmados': {
      bg: 'bg-green-500/10',
      border: 'border-green-500/30',
      text: 'text-green-600',
      hover: 'hover:bg-green-500/20 hover:border-green-500/50',
      animation: '',
    },
    'tempo-expirado': {
      bg: 'bg-red-500/10',
      border: 'border-red-500/30',
      text: 'text-red-600',
      hover: 'hover:bg-red-500/20 hover:border-red-500/50',
      animation: count > 0 ? 'animate-pulse-critical' : '',
    },
    'dez-minutos': {
      bg: 'bg-yellow-500/10',
      border: 'border-yellow-500/30',
      text: 'text-yellow-600',
      hover: 'hover:bg-yellow-500/20 hover:border-yellow-500/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'cinco-minutos': {
      bg: 'bg-amber-500/10',
      border: 'border-amber-500/30',
      text: 'text-amber-600',
      hover: 'hover:bg-amber-500/20 hover:border-amber-500/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'com-operador': {
      bg: 'bg-emerald-500/10',
      border: 'border-emerald-500/30',
      text: 'text-emerald-600',
      hover: 'hover:bg-emerald-500/20 hover:border-emerald-500/50',
      animation: '',
    },
    'cenarios-crise': {
      bg: 'bg-purple-500/10',
      border: 'border-purple-500/30',
      text: 'text-purple-600',
      hover: 'hover:bg-purple-500/20 hover:border-purple-500/50',
      animation: count > 0 ? 'animate-glow-crisis' : '',
    },
  };

  const style = typeStyles[type as keyof typeof typeStyles];

  return (
    <div
      onClick={onClick}
      className={cn(
        "p-4 rounded-lg border-2 cursor-pointer transition-all duration-300 hover:scale-102 relative",
        style.bg,
        style.border,
        style.hover,
        style.animation,
        isActive && "ring-2 ring-primary/50 ring-offset-2 ring-offset-background"
      )}
    >
      <div className="flex items-center justify-between gap-3">
        <div className="flex items-center gap-3 flex-1 min-w-0">
          <div className={cn("p-2 rounded-lg bg-black/20 flex-shrink-0", style.text)}>
            <Icon size={18} />
          </div>
          
          <div className="flex-1 min-w-0">
            <div className={cn("text-xs font-medium uppercase tracking-wide truncate", style.text)}>
              {title}
            </div>
            <div className="text-xs text-muted-foreground truncate">
              {count === 0 ? "Nenhum" : `${count}/${totalCount}`}
            </div>
          </div>
        </div>

        <div className={cn("text-2xl font-bold flex-shrink-0", style.text)}>
          {count}
        </div>
      </div>

      {isActive && (
        <div className="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full animate-pulse" />
      )}
    </div>
  );
}



DASHBOARD:
import { useState, useEffect } from 'react';
import {
  Settings,
  Sun,
  Moon,
  AlertTriangle,
  FileText,
  MessageSquare,
  BookOpen,
  Shield
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { toast } from '@/hooks/use-toast';
import { MonitoringCards } from '@/components/MonitoringCards';
import { ActionTable } from '@/components/ActionTable';
import { CriticalIncidents } from '@/components/CriticalIncidents';
import { RDMTracker } from '@/components/RDMTracker';
import { ShiftNotes } from '@/components/ShiftNotes';
import { WebhookConfig } from '@/components/WebhookConfig';
import { InstructionsSection } from '@/components/InstructionsSection';
import { Sheet, SheetContent } from "@/components/ui/sheet";
import OutageManager, { Outage } from '@/components/OutageManager';

export interface AlertData {
  id: string;
  chamado: string;
  tipo_chamado: string;
  grupo_chamado: string;
  status_chamado: string;
  abertura_chamado: string;
  resumo_chamado: string;
  severidade_chamado: string;
  acionado: string;
  chat: boolean;
  link_chamado: string;
  timestamp_chat?: string;
  sending_chat?: boolean;
}

const Dashboard = () => {
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [showWebhookConfig, setShowWebhookConfig] = useState(false);
  const [alertData, setAlertData] = useState<AlertData[]>([]);
  const [loading, setLoading] = useState(false);
  const [activeSection, setActiveSection] = useState<'incidents' | 'rdm' | 'notes' | 'instructions' | 'security' | null>(null);
  const [filter, setFilter] = useState<string | null>(null);
  const [outages, setOutages] = useState<Outage[]>([]);
  

  const fetchAlertData = async () => {
    setLoading(true);
    try {
      const response = await fetch('https://f6ffk8e9fe.execute-api.us-east-1.amazonaws.com/prod/dados');

      if (!response.ok) {
        throw new Error(`HTTP error! status_chamado: ${response.status}`);
      }

      const data = await response.json();
      console.log("data from API:", data);

      const apiData = Array.isArray(data)
        ? data
        : data.body
          ? JSON.parse(data.body)
          : [];

      if (!apiData || apiData.length === 0) {
        throw new Error("Nenhum dado encontrado");
      }

      const transformedData: AlertData[] = apiData.map((item: any, index: number) => ({
        id: `alert-${index}`,
        tipo_chamado: item.tipo_chamado || 'N/A',
        chamado: item.chamado || 'N/A',
        grupo_chamado: item.grupo_chamado || 'N/A',
        status_chamado: item.status_chamado || 'N/A',
        abertura_chamado: item.dat_abertura_chamado || item.abertura_chamado || item.data_abertura || '',
        resumo_chamado: item.resumo_chamado || 'Título não disponível',
        severidade_chamado: item.severidade_chamado || 'N/A',
        acionado: item.acionado || 'N/A',
        chat: false,
        link_chamado: item.link_chamado || '',
        timestamp_chat: item.timestamp_chat || item.chat_timestamp || undefined,
        sending_chat:
          typeof item.sending_chat === 'boolean'
            ? item.sending_chat
            : typeof item.sending_chat === 'string'
              ? item.sending_chat.trim().toLowerCase() === 'true'
              : typeof item.sending_chat === 'number'
                ? item.sending_chat === 1
                : undefined,
      }));

      setAlertData(transformedData);

      const unacknowledged = transformedData.filter(alert => !alert.acionado);
      if (unacknowledged.length > 0) {
        playAlertSound();
      }
    } catch (error) {
      console.error('Error fetching data:', error);
      toast({
        title: "Erro ao buscar dados",
        description: "Não foi possível conectar com a API",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const playAlertSound = () => {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+Dqu2sgBDR+w/PCaWEbEBOa5rWgdyoEKAA=');
    audio.play().catch(() => {
      console.log('Alert sound could not be played');
    });
  };

  const toggleTheme = () => {
    setIsDarkMode(!isDarkMode);
    if (isDarkMode) {
      document.documentElement.classList.remove('dark');
      document.documentElement.classList.add('light');
    } else {
      document.documentElement.classList.remove('light');
      document.documentElement.classList.add('dark');
    }
  };

  const updateAlertAcknowledgment = (alertId: string, acknowledged: boolean) => {
    setAlertData(prev =>
      prev.map(alert =>
        alert.id === alertId
          ? { ...alert, chat: acknowledged }
          : alert
      )
    );
  };

  useEffect(() => {
    fetchAlertData();
    const interval = setInterval(fetchAlertData, 600000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    document.documentElement.classList.add('dark');
  }, []);

  useEffect(() => {
    try {
      const raw = localStorage.getItem('outages');
      if (raw) {
        const parsed: any[] = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          const mapped: Outage[] = parsed.map((o: any) => {
            if (typeof o.startAt === 'number' && typeof o.endAt === 'number') return o as Outage;
            const created = typeof o.createdAt === 'number' ? o.createdAt : Date.now();
            const startAt = created;
            const endAt = typeof o.expiresAt === 'number' ? o.expiresAt : created + 30 * 60000;
            return { id: o.id || `outage-${created}`, title: o.title, startAt, endAt, createdAt: created } as Outage;
          });
          setOutages(mapped);
        } else {
          setOutages([]);
        }
      }
    } catch {}
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem('outages', JSON.stringify(outages));
    } catch {}
  }, [outages]);

  useEffect(() => {
    const id = setInterval(() => {
      const now = Date.now();
      setOutages((prev) => prev.filter((o) => now <= o.endAt));
    }, 60000);
    return () => clearInterval(id);
  }, []);

  const addOutage = (title: string, startAt: number, endAt: number) => {
    const id = `outage-${startAt}-${Math.random().toString(36).slice(2, 8)}`;
    setOutages((prev) => [
      ...prev.filter(o => o.title !== title || !(startAt <= o.endAt && endAt >= o.startAt)),
      { id, title, startAt, endAt, createdAt: Date.now() }
    ]);
  };

  const removeOutage = (id: string) => {
    setOutages((prev) => prev.filter((o) => o.id !== id));
  };

  const sidebarItems = [
    { title: "Incidentes Críticos", icon: AlertTriangle, key: 'incidents' as const },
    { title: "Acompanhamento RDMs", icon: FileText, key: 'rdm' as const },
    { title: "Recados do Turno", icon: MessageSquare, key: 'notes' as const },
    { title: "Instruções Operacionais", icon: BookOpen, key: 'instructions' as const },
  ];

  const nowTs = Date.now();
  const activeOutages = outages.filter(o => nowTs >= o.startAt && nowTs <= o.endAt);

  const filteredData = filter
    ? alertData.filter(alert => {
      if (filter === 'SEV4_INCIDENT') {
        return alert.tipo_chamado.toLowerCase().includes('incidente')
          && alert.severidade_chamado.includes('4')
      }
      if (filter === 'SEV4_INCIDENT_TOTAL') {
        return alert.tipo_chamado.toLowerCase().includes('incidente')
          && alert.severidade_chamado.includes('4');
      }
      if (filter === 'SEV4_ALERT') {
        return alert.tipo_chamado.toLowerCase().includes('alerta')
          && alert.severidade_chamado.includes('4')
          && alert.acionado !== 'OK'
      }
      if (filter === 'SEV4_ALERT_TOTAL') {
        return alert.tipo_chamado.toLowerCase().includes('alerta')
          && alert.severidade_chamado.includes('4');
      }
      if (filter === 'SEV3_INCIDENT') {
        return alert.tipo_chamado.toLowerCase().includes('incidente')
          && alert.severidade_chamado.includes('3')
      }
      if (filter === 'SEV3_INCIDENT_TOTAL') {
        return alert.tipo_chamado.toLowerCase().includes('incidente')
          && alert.severidade_chamado.includes('3');
      }
      return true;
    })
    : alertData;

  const outageFilteredData = filteredData.filter(alert => {
    const title = (alert.resumo_chamado || '').trim().toLowerCase();
    return !activeOutages.some(o => title === String(o.title || '').trim().toLowerCase());
  });

  return (
    <div className="min-h-screen flex flex-col bg-background text-foreground">
      {/* Header */}
      <header className="bg-dashboard-bg border-b border-border p-6 text-center">
        <h1
          className="text-3xl font-bold mb-2"
          style={{
            color: isDarkMode ? '#d2d3d8ff' : '#4a90e2',
          }}
        >
          PAINEL CIOPS - MONITORAÇÃO
        </h1>
      </header>

      {/* Main Layout: 3 colunas */}
      <div className="flex-1 flex bg-dashboard-bg overflow-hidden">
        {/* Coluna Esquerda - Cards/Filtros */}
        <aside className="w-64 bg-dashboard-bg border-r border-border overflow-y-auto p-4">
          <MonitoringCards
            alertData={alertData}
            onFilterSelect={(filterKey) => setFilter(prev => prev === filterKey ? null : filterKey)}
          />
        </aside>

        {/* Coluna Central - Tabela */}
        <main className="flex-1 overflow-y-auto p-6">
          <ActionTable
            alertData={outageFilteredData}
            onUpdateAcknowledgment={updateAlertAcknowledgment}
            loading={loading}
          />
        </main>

        {/* Coluna Direita - Sidebar */}
        <aside className="w-20 bg-gradient-to-b from-sidebar-background to-sidebar-background/95 border-l border-sidebar-border/50 backdrop-blur-sm flex flex-col justify-between shadow-lg">
          {/* Parte superior - Menu items */}
          <div className="flex flex-col gap-3 p-3 flex-1">
            {sidebarItems.map((item) => (
              <Button
                key={item.key}
                variant="ghost"
                size="icon"
                onClick={() => setActiveSection(activeSection === item.key ? null : item.key)}
                className={`w-14 h-14 rounded-xl transition-all duration-300 relative group ${activeSection === item.key
                  ? 'bg-gradient-to-br from-sidebar-primary to-sidebar-primary/90 text-sidebar-primary-foreground shadow-lg scale-105'
                  : 'text-sidebar-foreground hover:bg-sidebar-accent/80 hover:text-sidebar-accent-foreground hover:scale-105'
                  }`}
                title={item.title}
              >
                <item.icon className="h-6 w-6 transition-transform duration-300 group-hover:scale-110" />
                {activeSection === item.key && (
                  <div className="absolute -right-1 top-1/2 transform -translate-y-1/2 w-1 h-8 bg-sidebar-primary-foreground rounded-full opacity-80"></div>
                )}
              </Button>
            ))}
          </div>

          {/* Parte inferior - Security + Settings */}
          <div className="flex flex-col gap-3 p-3 border-t border-sidebar-border/30">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setActiveSection('security')}
              className="w-14 h-14 rounded-xl text-sidebar-foreground hover:bg-sidebar-accent/80 hover:text-sidebar-accent-foreground transition-all duration-300 hover:scale-105 group"
              title="Segurança"
            >
              <Shield className="h-5 w-5 transition-transform duration-300 group-hover:scale-110" />
            </Button>
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setShowWebhookConfig(true)}
              className="w-14 h-14 rounded-xl text-sidebar-foreground hover:bg-sidebar-accent/80 hover:text-sidebar-accent-foreground transition-all duration-300 hover:scale-105 group"
              title="Configuração de Webhooks"
            >
              <Settings className="h-5 w-5 transition-transform duration-300 group-hover:rotate-90" />
            </Button>
            <Button
              variant="ghost"
              size="icon"
              onClick={toggleTheme}
              className="w-14 h-14 rounded-xl text-sidebar-foreground hover:bg-sidebar-accent/80 hover:text-sidebar-accent-foreground transition-all duration-300 hover:scale-105 group"
              title="Trocar Tema"
            >
              <div className="transition-transform duration-500 group-hover:rotate-180">
                {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
              </div>
            </Button>
          </div>
        </aside>
      </div>

      {/* Drawer */}
      <Sheet open={!!activeSection} onOpenChange={() => setActiveSection(null)}>
        <SheetContent
          side="right"
          className="w-full"
          style={{ width: '50vw', maxWidth: '1000px' }}
        >
          <div className="mt-4">
            {activeSection === 'incidents' && <CriticalIncidents />}
            {activeSection === 'rdm' && <RDMTracker />}
            {activeSection === 'notes' && <ShiftNotes />}
            {activeSection === 'instructions' && <InstructionsSection />}
            {activeSection === 'security' && (
              <OutageManager
                outages={outages}
                onAdd={addOutage}
                onRemove={removeOutage}
              />
            )}
          </div>
        </SheetContent>
      </Sheet>

      {/* Webhook Config Modal */}
      <WebhookConfig
        open={showWebhookConfig}
        onOpenChange={setShowWebhookConfig}
      />
    </div>
  );
};

export default Dashboard;

