import json
import boto3
import os
from datetime import datetime

dynamodb = boto3.resource("dynamodb")
connections_table = dynamodb.Table(os.environ["CONNECTIONS_TABLE"])

def lambda_handler(event, context):
    print("CONNECT EVENT:", event)

    connection_id = event["requestContext"]["connectionId"]

    try:
        # Salva conexão no DynamoDB
        connections_table.put_item(
            Item={
                "connectionId": connection_id,
                "connectedAt": int(datetime.utcnow().timestamp())
            }
        )
        print(f"Conexão registrada: {connection_id}")

        return {
            "statusCode": 200,
            "body": "Connected."
        }

    except Exception as e:
        print("Erro ao salvar conexão:", str(e))
        return {
            "statusCode": 500,
            "body": "Erro ao conectar."
        }
