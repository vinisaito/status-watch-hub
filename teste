def handle_update_status_final(event, trace, body):
    chamado = int(body["chamado"])
    status = body["status"]
    level = body.get("level")  # opcional
    now = datetime.now(timezone.utc).isoformat()

    # Pega o estado atual do chamado
    resp = table.get_item(Key={"chamado": chamado})
    state_atual = resp.get("Item", {})

    update = {"statusFinal": status, "statusFinal_updatedAt": now}

    if level:
        update[f"level{level}_status"] = status
        update[f"level{level}_updatedAt"] = now
    else:
        for i in range(1, 6):
            if state_atual.get(f"level{i}_status") == "running":
                update[f"level{i}_status"] = status
                update[f"level{i}_updatedAt"] = now
                break

    state = update_chamado(trace, chamado, update)
    broadcast({"event": "updateStatusFinal", "chamado": chamado, "state": state})
    return {"statusCode": 200, "body": json.dumps({"msg": "Status final atualizado"}, cls=DecimalEncoder)}








def handle_update_acionamento(event, trace, body):
    chamado = int(body["chamado"])
    level = int(body.get("level", 1))
    now = datetime.now(timezone.utc).isoformat()

    observacao = body.get("observacao")
    pessoa_acionada = body.get("pessoaAcionada")
    status_acionamento = body.get("statusAcionamento")
    operador = body.get("operador")

    update = {f"level{level}_updatedAt": now}  # sempre marca o horário da alteração

    if observacao is not None:
        update[f"level{level}_observacao"] = observacao
    if pessoa_acionada is not None:
        update[f"level{level}_pessoaAcionada"] = pessoa_acionada
    if status_acionamento is not None:
        update[f"level{level}_statusAcionamento"] = status_acionamento
    if operador is not None:
        update[f"level{level}_operador"] = operador

    state = update_chamado(trace, chamado, update)

    broadcast({
        "event": "updateAcionamento",
        "chamado": chamado,
        "level": level,
        "state": state
    })
    return {"statusCode": 200, "body": json.dumps({"msg": f"Dados do acionamento do level {level} atualizados"}, cls=DecimalEncoder)}



