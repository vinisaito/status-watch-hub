import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { useState } from 'react';
import { useChatAcionados } from '@/hooks/use-chat-acionados';
import { AlertTriangle, AlertCircle, Clock, Timer, UserCheck, BarChart3, MessageCircle, CheckCircle2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AlertData {
  id: string;
  chamado: string;
  tipo_chamado: string;
  grupo_chamado: string;
  status_chamado: string;
  abertura_chamado: string;
  resumo_chamado: string;
  severidade_chamado: string;
  acionado: string;
  chat: boolean;
}

interface MonitoringCardsProps {
  alertData: AlertData[];
  onFilterSelect: (filter: string | null) => void;
}

export const MonitoringCards = ({ alertData, onFilterSelect }: MonitoringCardsProps) => {
  const [activeFilter, setActiveFilter] = useState<string | null>(null);
  
  // Usando o hook para obter os chamados acionados
  const { isAcionado } = useChatAcionados();

  // Função toggle do filtro
  const handleCardClick = (filterKey: string) => {
    if (activeFilter === filterKey) {
      setActiveFilter(null);
      onFilterSelect(null);
    } else {
      setActiveFilter(filterKey);
      onFilterSelect(filterKey);
    }
  };

  // Função para calcular tempo restante em minutos
  const getTimeRemaining = (openingTime: string) => {
    const now = new Date();
    const opening = new Date(openingTime);
    const diffMs = now.getTime() - opening.getTime();
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    // Assumindo SLA de 60 minutos para alertas críticos
    const slaMinutes = 60;
    return slaMinutes - diffMinutes;
  };

  // Métricas básicas
  const total = alertData.length;
  
  const pendenteEnvioChat = alertData.filter(alert => 
    !alert.chat && !isAcionado(alert.chamado)
  ).length;

  const confirmados = alertData.filter(alert => 
    alert.chat || isAcionado(alert.chamado)
  ).length;

  // Métricas baseadas em tempo
  const tempoExpirado = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining <= 0 && !isAcionado(alert.chamado);
  }).length;

  const dezMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining > 0 && timeRemaining <= 10 && !isAcionado(alert.chamado);
  }).length;

  const cincoMinutosRestantes = alertData.filter(alert => {
    const timeRemaining = getTimeRemaining(alert.abertura_chamado);
    return timeRemaining > 0 && timeRemaining <= 5 && !isAcionado(alert.chamado);
  }).length;

  const comOperador = alertData.filter(alert => 
    alert.acionado === 'OK' || isAcionado(alert.chamado)
  ).length;

  const cenariosCrise = alertData.filter(alert =>
    alert.severidade_chamado.includes('5') && !isAcionado(alert.chamado)
  ).length;

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4 w-full max-w-none">
      {/* Total */}
      <CompactCard
        title="Total"
        count={total}
        totalCount={alertData.length}
        icon={BarChart3}
        type="total"
        filterKey="TOTAL"
        isActive={activeFilter === 'TOTAL'}
        onClick={() => handleCardClick('TOTAL')}
      />

      {/* Pendente Envio Chat */}
      <CompactCard
        title="Pendente Envio Chat"
        count={pendenteEnvioChat}
        totalCount={alertData.length}
        icon={MessageCircle}
        type="pendente-chat"
        filterKey="PENDENTE_ENVIO_CHAT"
        isActive={activeFilter === 'PENDENTE_ENVIO_CHAT'}
        onClick={() => handleCardClick('PENDENTE_ENVIO_CHAT')}
      />

      {/* Confirmados */}
      <CompactCard
        title="Confirmados"
        count={confirmados}
        totalCount={alertData.length}
        icon={CheckCircle2}
        type="confirmados"
        filterKey="CONFIRMADOS"
        isActive={activeFilter === 'CONFIRMADOS'}
        onClick={() => handleCardClick('CONFIRMADOS')}
      />

      {/* Tempo Expirado */}
      <CompactCard
        title="Tempo Expirado"
        count={tempoExpirado}
        totalCount={alertData.length}
        icon={AlertTriangle}
        type="tempo-expirado"
        filterKey="TEMPO_EXPIRADO"
        isActive={activeFilter === 'TEMPO_EXPIRADO'}
        onClick={() => handleCardClick('TEMPO_EXPIRADO')}
      />

      {/* 10 Minutos Restantes */}
      <CompactCard
        title="10min Restantes"
        count={dezMinutosRestantes}
        totalCount={alertData.length}
        icon={Clock}
        type="dez-minutos"
        filterKey="DEZ_MINUTOS"
        isActive={activeFilter === 'DEZ_MINUTOS'}
        onClick={() => handleCardClick('DEZ_MINUTOS')}
      />

      {/* 5 Minutos Restantes */}
      <CompactCard
        title="5min Restantes"
        count={cincoMinutosRestantes}
        totalCount={alertData.length}
        icon={Timer}
        type="cinco-minutos"
        filterKey="CINCO_MINUTOS"
        isActive={activeFilter === 'CINCO_MINUTOS'}
        onClick={() => handleCardClick('CINCO_MINUTOS')}
      />

      {/* Com Operador */}
      <CompactCard
        title="Com Operador"
        count={comOperador}
        totalCount={alertData.length}
        icon={UserCheck}
        type="com-operador"
        filterKey="COM_OPERADOR"
        isActive={activeFilter === 'COM_OPERADOR'}
        onClick={() => handleCardClick('COM_OPERADOR')}
      />

      {/* Cenários de Crise */}
      <CompactCard
        title="Cenários de Crise"
        count={cenariosCrise}
        totalCount={alertData.length}
        icon={AlertCircle}
        type="cenarios-crise"
        filterKey="CENARIOS_CRISE"
        isActive={activeFilter === 'CENARIOS_CRISE'}
        onClick={() => handleCardClick('CENARIOS_CRISE')}
      />
    </div>
  );
};

interface CompactCardProps {
  title: string;
  count: number;
  totalCount: number;
  icon: React.ComponentType<any>;
  type: string;
  filterKey: string;
  isActive: boolean;
  onClick: () => void;
}

function CompactCard({ title, count, totalCount, icon: Icon, type, isActive, onClick }: CompactCardProps) {
  const typeStyles = {
    'total': {
      bg: 'bg-total/10',
      border: 'border-total/30',
      text: 'text-total',
      hover: 'hover:bg-total/20 hover:border-total/50',
      animation: '',
    },
    'pendente-chat': {
      bg: 'bg-pendente-chat/10',
      border: 'border-pendente-chat/30',
      text: 'text-pendente-chat',
      hover: 'hover:bg-pendente-chat/20 hover:border-pendente-chat/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'confirmados': {
      bg: 'bg-confirmados/10',
      border: 'border-confirmados/30',
      text: 'text-confirmados',
      hover: 'hover:bg-confirmados/20 hover:border-confirmados/50',
      animation: '',
    },
    'tempo-expirado': {
      bg: 'bg-critical/10',
      border: 'border-critical/30',
      text: 'text-critical',
      hover: 'hover:bg-critical/20 hover:border-critical/50',
      animation: count > 0 ? 'animate-pulse-critical' : '',
    },
    'dez-minutos': {
      bg: 'bg-warning/10',
      border: 'border-warning/30', 
      text: 'text-warning',
      hover: 'hover:bg-warning/20 hover:border-warning/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'cinco-minutos': {
      bg: 'bg-caution/10',
      border: 'border-caution/30',
      text: 'text-caution',
      hover: 'hover:bg-caution/20 hover:border-caution/50',
      animation: count > 0 ? 'animate-pulse' : '',
    },
    'com-operador': {
      bg: 'bg-success/10',
      border: 'border-success/30',
      text: 'text-success',
      hover: 'hover:bg-success/20 hover:border-success/50',
      animation: '',
    },
    'cenarios-crise': {
      bg: 'bg-crisis/10',
      border: 'border-crisis/30',
      text: 'text-crisis',
      hover: 'hover:bg-crisis/20 hover:border-crisis/50',
      animation: count > 0 ? 'animate-glow-crisis' : '',
    },
  };

  const style = typeStyles[type as keyof typeof typeStyles];

  return (
    <div
      onClick={onClick}
      className={cn(
        "p-6 rounded-lg border-2 cursor-pointer transition-all duration-300 hover:scale-105",
        style.bg,
        style.border,
        style.hover,
        style.animation,
        isActive && "ring-2 ring-primary/50 ring-offset-2 ring-offset-background"
      )}
    >
      <div className="flex flex-col items-center text-center space-y-3">
        <div className={cn("p-2 rounded-lg bg-black/20", style.text)}>
          <Icon size={20} />
        </div>
        
        <div className={cn("text-3xl font-bold", style.text)}>
          {count}
        </div>
        
        <div className="space-y-1">
          <div className={cn("text-xs font-medium uppercase tracking-wide", style.text)}>
            {title}
          </div>
          <div className="text-xs text-muted-foreground">
            {count === 0 ? "Nenhum pendente" : `${count} de ${totalCount}`}
          </div>
        </div>
      </div>
      
      {/* Active indicator */}
      {isActive && (
        <div className="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full animate-pulse" />
      )}
    </div>
  );
}

interface CompactSubCardProps {
  label: string;
  count: number;
  type: string;
  filterKey: string;
  isActive: boolean;
  onClick: () => void;
}

function CompactSubCard({ label, count, type, isActive, onClick }: CompactSubCardProps) {
  const typeStyles = {
    'total': 'text-total border-total/20 hover:border-total/40',
    'pendente-chat': 'text-pendente-chat border-pendente-chat/20 hover:border-pendente-chat/40',
    'confirmados': 'text-confirmados border-confirmados/20 hover:border-confirmados/40',
    'tempo-expirado': 'text-critical border-critical/20 hover:border-critical/40',
    'dez-minutos': 'text-warning border-warning/20 hover:border-warning/40',
    'cinco-minutos': 'text-caution border-caution/20 hover:border-caution/40',
    'com-operador': 'text-success border-success/20 hover:border-success/40',
    'cenarios-crise': 'text-crisis border-crisis/20 hover:border-crisis/40',
  };

  return (
    <div
      onClick={onClick}
      className={cn(
        "p-3 rounded-lg bg-panel-bg/50 border cursor-pointer transition-all duration-200 hover:scale-105",
        typeStyles[type as keyof typeof typeStyles],
        isActive && "ring-2 ring-primary/50 ring-offset-1 ring-offset-background"
      )}
    >
      <div className="flex items-center justify-between">
        <span className="text-sm text-muted-foreground">{label}</span>
        <span className={cn("text-lg font-semibold", typeStyles[type as keyof typeof typeStyles].split(' ')[0])}>
          {count}
        </span>
      </div>
    </div>
  );
}
