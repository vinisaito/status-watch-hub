def get_state(event):
    body = json.loads(event.get("body", "{}"))
    chamado = int(body["chamado"])

    response = chamados_table.get_item(Key={"chamado": chamado})
    item = response.get("Item")

    apigw = get_apigw_client(event)   # <-- importante, usa o event da NOVA conexÃ£o
    connection_id = event["requestContext"]["connectionId"]

    if not item:
        message = {
            "action": "currentState",
            "chamado": chamado,
            "status": "pendente",
            "timerEnd": None,
            "serverTime": int(datetime.utcnow().timestamp())
        }
    else:
        message = {
            "action": "currentState",
            "chamado": chamado,
            "status": item.get("status", "pendente"),
            "timerEnd": int(item["timerEnd"]),
            "serverTime": int(datetime.utcnow().timestamp())
        }

    try:
        apigw.post_to_connection(
            Data=to_json(message),
            ConnectionId=connection_id
        )
    except Exception as e:
        print(f"Erro ao enviar estado atual: {e}")

    return {"statusCode": 200, "body": "State sent"}
